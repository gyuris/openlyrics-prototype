#! /bin/bash

# Prerequisites: xsltproc, prince (v12)
# Usage:         ./make-pdf FILE
# Example:       ./make-pdf A\ béke\ napja\ közel.xml

# Exit immediately if a command exits with a non-zero status.
set -e

# Params
########
if [ -z "$1" ]; then
  echo "Usage: ./make-pdf FILE"
  exit 1
fi

if [ ! -f "$1" ]; then
  echo "\"$1\" doesn't exist. Enter a valid XML file."
  exit 1
fi

# Variables
###########
file=$1
name="$(basename "$file" .xml)"
js="stylesheets/css/xml/openlyrics-0.9-chord.xml.js" # Prince JS tweak
author="Gyuris Gellért" # Author for PDF
book="book" # Book 

# Running
#########

echo -n "Making \"$file\"... "

# Generate PDF from original XML
prince --javascript --script=$js "$file" -o "pdf/$name.pdf" --pdf-author="$author" --pdf-title="$name" --no-warn-css-unsupported

# Replace CSS with XSL and remove CSS tweaks, save it in another file
if [[ $name != 'book' ]]; then
  sed -e 's/href="stylesheets\/openlyrics\.css" type="text\/css"/href="stylesheets\/openlyrics\.xsl" type="text\/xsl"/g' \
      -e 's/ tweak="nested"//g' \
      -e 's/ tweak="linebreak"//g' \
      "$file" > "$name.xsl.xml"
else
  # Book needs extra xslt tranlsation to do xi:includes but without --xinclude param
  xsltproc "$file" > "$name.xsl.xml"
  # Replace CSS with XSL and remove CSS tweaks
  sed -i -e 's/href="stylesheets\/openlyrics\.css" type="text\/css"/href="stylesheets\/openlyrics\.xsl" type="text\/xsl"/g' \
      -e 's/ tweak="nested"//g' \
      -e 's/ tweak="linebreak"//g' \
      "$name.xsl.xml"
fi

# Generate PDF from XSL(HTML) version
xsltproc "$name.xsl.xml" | prince -o "pdf/$name.xsl.pdf" --pdf-author="$author" --pdf-title="$name"  --no-warn-css-unsupported -  

echo "done"
